# 微服务项目问题复盘

## 项目背景
使用 Spring Boot 3.0.2 + Spring Cloud 2022.0.0 + Nacos 实现的微服务项目，包含 `hello-provider` 和 `hello-consumer` 两个模块。

## 问题时间线

### 1. 初始问题：Gradle 转 Maven
- **问题现象**：IDE 中 Gradle 模块出现红色波浪线，追踪无具体报错文件
- **个人推测**：IDEA 和 Gradle 的版本不匹配，或者 IDEA 缓存问题。
- **决策**：将项目从 Gradle 转换为 Maven 构建

### 2. 依赖配置问题
- **缺失 Spring Cloud Starter 依赖**：`hello-consumer/pom.xml` 缺少 `spring-cloud-starter`，导致 Spring Cloud 功能无法使用
- **Java 版本不一致**：部分模块 Java 版本配置冲突（17 vs 21）
- **Lombok 版本问题**：Lombok 1.18.24 不兼容 Java 21，导致编译错误

### 3. 服务配置问题
- **Nacos 配置**：服务注册到公网 IP 而非 localhost
- **服务名不一致**：provider 服务名配置问题

### 4. 代码实现问题
- **RestTemplate 配置**：未正确配置负载均衡的 RestTemplate
- **Feign 客户端接口**：路径参数缺失 `value` 属性
- **服务调用失败**：Feign 和 RestTemplate 调用均返回 502 Bad Gateway



## 核心问题分析

### 关键错误：502 Bad Gateway

#### 根本原因
1. **服务注册异常**：`hello-provider` 初始注册到公网 IP（113.54.254.181）而非 localhost
2. **服务发现缓存**：`hello-consumer` 启动时加载缓存，获取到错误的服务实例
3. **调用链失败**：consumer 尝试调用公网 IP，导致网络请求失败

#### 技术细节
- Nacos 客户端默认使用主机的公网 IP 注册服务
- `naming-load-cache-at-start: true` 导致 consumer 启动时加载旧缓存
- Spring Cloud LoadBalancer 无法正确解析服务实例

## 解决方案

### 1. 依赖修复

#### `hello-consumer/pom.xml`
- 添加缺失依赖：
  ```xml
  <!-- Spring Cloud Starter -->
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter</artifactId>
  </dependency>
  ```
- 统一 Java 版本为 17
- 更新 Lombok 到 1.18.30（兼容 Java 21）

### 2. 配置修复

#### `hello-provider/src/main/resources/application.yml`
```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        prefer-ip-address: true
        ip: 127.0.0.1  # 显式指定注册 IP
```

#### `hello-consumer/src/main/resources/application.yml`
```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        naming-load-cache-at-start: false  # 禁用启动缓存
        ip: 127.0.0.1
```

### 3. 代码修复

#### RestTemplate 配置
- 类名：`HelloConsumerProvider`
- 改为 `@Configuration` 注解
- 正确命名 RestTemplate  beans：
  ```java
  @Bean("loadBalancedRestTemplate")
  @LoadBalanced
  public RestTemplate loadBalancedRestTemplate() {
      return new RestTemplate();
  }
  ```

#### Feign 客户端接口
- 修复路径参数：
  ```java
  @GetMapping("/greet/{username}")
  String sayHello(@PathVariable("username") String username);
  ```

#### 跨域支持
- 在 `HelloProviderController` 添加 `@CrossOrigin` 注解

## 验证结果

### 测试端点
1. **Feign 调用**：`GET /enter/Y`
   - ✅ 返回 200 OK
   - 响应：`HelloConsumer received: Hello, Y <br>Service Name: hello-provider-service <br>Service Port: 8081`

2. **负载均衡 RestTemplate**：`GET /enter03/Y`
   - ✅ 返回 200 OK
   - 响应：`Hello, Y <br>Service Name: hello-provider-service <br>Service Port: 8081`

3. **直接调用**：`GET /test-direct`
   - ✅ 返回 200 OK

## 经验教训

### 配置规范
1. **显式配置服务 IP**：生产环境使用域名/固定 IP，开发环境使用 localhost
2. **禁用缓存**：开发环境禁用 Nacos 缓存，确保获取最新服务实例
3. **统一 Java 版本**：pom.xml 中统一 `java.version`、`maven.compiler.source`、`maven.compiler.target`

### 依赖管理
1. **使用 BOM**：通过 `dependencyManagement` 统一管理依赖版本
2. **排除冲突依赖**：如 Feign 中排除 Ribbon
3. **版本兼容性**：Lombok 版本需与 Java 版本匹配

### 服务调用
1. **RestTemplate 配置**：区分负载均衡和普通实例
2. **Feign 最佳实践**：
   - 明确指定路径参数名
   - 统一服务名配置
   - 添加合理的容错机制

### 开发流程
1. **验证服务注册**：启动服务后检查 Nacos 控制台
2. **逐步测试**：先测试单个服务，再测试服务间调用
3. **日志排查**：利用 `curl -v` 和 IDE 控制台查看详细错误

## 最终状态
- ✅ 项目成功从 Gradle 转为 Maven
- ✅ 所有服务正常启动
- ✅ 服务间调用成功
- ✅ 端点返回 200 OK

## 后续优化建议
1. **添加容错机制**：Hystrix 或 Resilience4j
2. **完善日志**：添加业务日志和异常处理
3. **集成测试**：编写服务间调用的测试用例
4. **监控告警**：集成 Spring Boot Actuator 和 Prometheus

---

**复盘时间**：2025-12-16
**参与人员**：开发团队
**项目版本**：v0.0.1-SNAPSHOT